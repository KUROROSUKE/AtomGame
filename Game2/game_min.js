let ai_hand=[],pl_hand=[],ai_selected_cards=[],ai_selected_place=[],pl_selected_cards=[],pl_selected_place=[],make_material={},pl_point=0,ai_point=0,card_num=8,pl_data=[],ai_data=[];const elementToNumber={H:1,He:2,Li:3,Be:4,B:5,C:6,N:7,O:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,S:16,Cl:17,Ar:18,K:19,Ca:20,Fe:26,Cu:29,Zn:30,I:53},elements=[...Array(30).fill("H"),...Array(25).fill("O"),...Array(20).fill("C"),"He","Li","Be","B","N","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Fe","Cu","Zn","I"],element=["H","O","C","He","Li","Be","B","N","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Fe","Cu","Zn","I"];let materials,imageCache={},turn;const ai_hand_div=document.getElementById("ai_hand");function startGame(){document.getElementById("ai_div").style.display="inline-block",document.getElementById("pl_div").style.display="inline-block",make_initial_hand(),console.log(ai_hand,pl_hand),turn=Math.random()>.5?"ai":"pl",console.log(turn),"ai"==turn&&(view_pl_hand(),ai_turn()),"pl"==turn&&(view_ai_hand(),pl_turn())}async function loadMaterials(){let e=await fetch("../compound/standard.json"),t=await e.json();if(!t.material||!Array.isArray(t.material))return console.error('Loaded data does not contain a valid "material" array:',t),[];materials=t.material}async function preloadImages(){[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,26,29,30,53].forEach(e=>{let t=new Image;t.src=`../image/${e}.webp`,imageCache[e]=t}),console.log(imageCache)}async function ai_turn(){if("ai"==turn){if(view_ai_hand(),document.getElementById("pl_exchange_button").classList.add("disabled"),document.getElementById("pl_generate_button").classList.add("disabled"),document.getElementById("chemicalTable").classList.contains("hidden")||document.getElementById("chemicalTable").classList.toggle("hidden"),make_material=await ai_make_materials(),console.log(make_material),null==make_material){console.log("exchange");await select_ai_cards(await ai_exchange_materials()),ai_exchange()}else await select_ai_cards(make_material.components),ai_generate()}}async function ai_exchange_materials(){let e=ai_hand.reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{}),t=null,a=1/0;for(let[n,l]of Object.entries(e))l<a&&(t=n,a=l);let i={};return i[t]=a,i}function pl_turn(){"pl"==turn&&(view_pl_hand(),document.getElementById("pl_exchange_button").classList.remove("disabled"),document.getElementById("pl_generate_button").classList.remove("disabled"))}function ai_exchange(){ai_selected_cards.length>=1?(ai_data.push({hand:[ai_hand.slice()],action:"exchange",selected:array_to_obj(ai_selected_cards)}),ai_selected_place.forEach((e,t)=>{if(1==e){ai_hand[t]=get_random_card();let a=document.getElementsByClassName("ai_card")[t];a.classList.contains("selected")&&a.click()}}),turn="pl",view_ai_hand(),win_check(),pl_turn()):document.getElementById("ai_text").innerHTML="カードを選択してください"}function pl_exchange(){pl_selected_cards.length>=1?(pl_data.push({hand:[pl_hand.slice()],action:"exchange",selected:array_to_obj(pl_selected_cards)}),pl_selected_place.forEach((e,t)=>{if(1==e){pl_hand[t]=get_random_card();let a=document.getElementsByClassName("pl_card")[t];a.click()}}),turn="ai",view_pl_hand(),win_check(),ai_turn()):document.getElementById("pl_text").innerHTML="カードを選択してください"}async function ai_generate(){if(ai_selected_cards.length>=1){let e=await search_material(array_to_obj(ai_selected_cards));null!=e[0]?(ai_point+=e[0].point,document.getElementById("ai_point").innerHTML=`AIのポイント： ${ai_point}`,document.getElementById("ai_text").innerHTML=`${e[0].name} ： ${e[0].formula}`,ai_data.push({hand:[ai_hand.slice()],action:"generate",selected:array_to_obj(ai_selected_cards)}),ai_exchange()):(document.getElementById("ai_text").innerHTML="該当の物質がありません",ai_exchange())}else document.getElementById("ai_text").innerHTML="カードを選択してください",ai_exchange()}async function pl_generate(){if(pl_selected_cards.length>=1){let e=await search_material(array_to_obj(pl_selected_cards));null!=e[0]?(pl_point+=e[0].point,document.getElementById("pl_point").innerHTML=`プレイヤーのポイント： ${pl_point}`,document.getElementById("pl_text").innerHTML=`${e[0].name} ： ${e[0].formula}`,pl_data.push({hand:[pl_hand.slice()],action:"generate",selected:array_to_obj(pl_selected_cards)}),pl_exchange()):(document.getElementById("pl_text").innerHTML="該当の物質がありません",pl_selected_cards=[],pl_selected_place=[0,0,0,0,0,0,0,0],turn="ai",view_pl_hand(),win_check(),ai_turn())}else document.getElementById("pl_text").innerHTML="カードを選択してください"}function view_ai_hand(){let e=document.getElementById("ai_hand");e.innerHTML="",ai_hand.forEach((t,a)=>{let n=document.createElement("img");n.id=a,n.alt=t,n.src=imageCache[elementToNumber[n.alt]].src,n.style.height="auto",n.style.border="1px solid black",n.style.padding="5px",n.className="ai_card",n.addEventListener("click",function(){"ai"==turn&&(this.classList.contains("selected")?(this.classList.remove("selected"),this.style.padding="5px",this.style.border="1px solid black",ai_selected_cards.splice(ai_selected_cards.indexOf(this.alt),1),ai_selected_place[this.id]=0):(this.classList.add("selected"),this.style.padding="1px",this.style.border="5px solid red",ai_selected_cards.push(this.alt),ai_selected_place[this.id]=1))}),e.appendChild(n)})}function view_pl_hand(){let e=document.getElementById("pl_hand");e.innerHTML="",pl_hand.forEach((t,a)=>{let n=document.createElement("img");n.id=a,n.alt=t,n.src=imageCache[elementToNumber[n.alt]].src,n.style.height="auto",n.style.border="1px solid black",n.style.padding="5px",n.className="pl_card",n.addEventListener("click",function(){"pl"==turn&&(this.classList.contains("selected")?(this.classList.remove("selected"),this.style.padding="5px",this.style.border="1px solid black",pl_selected_cards.splice(pl_selected_cards.indexOf(this.alt),1),pl_selected_place[this.id]=0):(this.classList.add("selected"),this.style.padding="1px",this.style.border="5px solid red",pl_selected_cards.push(this.alt),pl_selected_place[this.id]=1))}),e.appendChild(n)})}function get_random_card(){return elements[Math.floor(Math.random()*elements.length)]}function make_initial_hand(){for(let e=0;e<card_num;e++)ai_hand.push(get_random_card()),pl_hand.push(get_random_card())}async function search_material(e){return materials.filter(t=>{for(let a in e)if(!t.components[a]||t.components[a]!==e[a])return!1;for(let n in t.components)if(!e[n])return!1;return!0})}function search_materials(e){return materials.filter(t=>{for(let a in t.components)if(!e[a]||t.components[a]>e[a])return!1;return!0})}async function ai_make_materials(){let e=ai_hand.reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{}),t=search_materials(e,materials);if(!t.length)return null;var a=0,n=0;return t.forEach(e=>{e.point>a&&(n=materials.indexOf(e),a=e.point)}),materials[n]}async function display_pl_hint(){let e=pl_hand.reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{}),t=search_materials(e,materials),a=document.getElementById("chemicalTable").getElementsByTagName("tbody")[0];a.innerHTML="",t.forEach(e=>{let t=a.insertRow();t.insertCell().textContent=e.name,t.insertCell().textContent=e.formula,t.insertCell().textContent=e.point;let n=Object.entries(e.components).map(([e,t])=>`${e}:${t}`);t.insertCell().textContent=n.join(", ")})}function obj_to_array(e){let t=[];for(let a in e)if(e.hasOwnProperty(a))for(let n=0;n<e[a];n++)t.push(a);return t}function array_to_obj(e){let t={};return e.forEach(e=>{t[e]?t[e]++:t[e]=1}),t}function delay(){return new Promise(e=>setTimeout(e,500))}function search_need_select(e){let t=[],a=document.getElementsByClassName("ai_card");for(var n=0;n<8;n++)e.includes(a[n].alt)&&(t.push(n),e.splice(e.indexOf(a[n].alt),1));return t}async function select_ai_cards(e){e=obj_to_array(e);let t=document.getElementsByClassName("ai_card"),a=await search_need_select(e);for(var n=0;n<8;n++)a.includes(n)&&(t[n].click(),await delay())}async function ai_exchange_materials(){let e=ai_hand.reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{}),t=null,a=1/0;for(let[n,l]of Object.entries(e))l<a&&(t=n,a=l);return{[t]:a}}function win_check(){if(!(pl_point>=250)&&!(ai_point>=250))return!1;{turn="end";let e=pl_point>=250?"プレイヤー":"AI";return e}}ai_hand_div.classList.add("disabled"),document.addEventListener("DOMContentLoaded",function(){loadMaterials(),preloadImages()}),document.getElementById("pl_exchange_button").addEventListener("click",function(){pl_exchange()}),document.getElementById("pl_generate_button").addEventListener("click",function(){pl_generate()}),document.getElementById("pl_hint_button").addEventListener("click",function(){document.getElementById("chemicalTable").classList.toggle("hidden"),display_pl_hint()});
