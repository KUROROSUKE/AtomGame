const elementToNumber={H:1,He:2,Li:3,Be:4,B:5,C:6,N:7,O:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,S:16,Cl:17,Ar:18,K:19,Ca:20,Fe:26,Cu:29,Zn:30,I:53},numberToElement=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,26,29,30,53],elements=[...Array(30).fill("H"),...Array(25).fill("O"),...Array(20).fill("C"),"He","Li","Be","B","N","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Fe","Cu","Zn","I"];let currentHand=[],selectedElements={},aiHand=[],aiPoints=0,playerHand=[],playerPoints=0,materials=[],imageCache={},isPlayerTurn=!0;async function loadMaterials(){let e=await fetch("../compound/standard.json"),n=await e.json();if(!n.material||!Array.isArray(n.material))return console.error('Loaded data does not contain a valid "material" array:',n),[];materials=n.material}function preloadImages(){[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,26,29,30,53].forEach(e=>{let n=new Image;n.src=`../image/${e}.webp`,imageCache[e]=n})}function drawRandomElements(e,n){let t=[];for(let a=0;a<n;a++){let l=Math.floor(Math.random()*e.length);t.push(e[l])}return t}function displayHand(e,n){let t=document.getElementById(n);t.innerHTML="",e.forEach(e=>{let a=document.createElement("div"),l=document.createElement("img");l.src=imageCache[elementToNumber[e]].src,l.alt=`Element ${e}`,a.appendChild(l),a.style.display="inline-block",a.style.border="1px solid black",a.style.padding="5px",a.className="card","hand"===n&&isPlayerTurn&&a.addEventListener("click",function(){this.classList.toggle("selected"),this.classList.contains("selected")?(selectedElements[e]=(selectedElements[e]||0)+1,this.style.border="5px solid red",this.style.padding="1px"):(this.style.border="1px solid black",this.style.padding="5px",selectedElements[e]&&(selectedElements[e]--,0===selectedElements[e]&&delete selectedElements[e]))}),t.appendChild(a)})}async function findMaterials(e){return materials.filter(n=>{for(let t in e)if(!n.components[t]||n.components[t]!==e[t])return!1;for(let a in n.components)if(!e[a])return!1;return!0})}function disableButtons(e){document.getElementById("exchangeButton").disabled=e,document.getElementById("searchButton").disabled=e}function updatePoints(e,n){aiPoints+=e.point,n.textContent=`AIポイント: ${aiPoints}`,checkWinCondition()}function replaceUsedCards(e,n,t=!1){for(let a in e.components)for(let l=0;l<e.components[a];l++){let i=n.indexOf(a);i>-1&&(n[i]=drawRandomElements(elements,1)[0])}t||(selectedElements={}),displayHand(n,t?"aiHand":"hand")}async function aiTurn(){isPlayerTurn=!1,clearAISelection(),disableButtons(!0);let e=await listCreatableMaterials(aiHand),n=document.getElementById("aiPoints"),t=document.getElementById("results"),a=decideCompound(aiHand,e);if(a){for(let l in console.log("AIが選択するはずのカード:",a.components),a.components){let i=a.components[l],d=document.querySelectorAll(`#aiHand img[alt="Element ${l}"]`);for(let s=0;s<d.length&&i>0;s++){let r=d[s].parentNode;r.classList.add("selected"),r.style.border="5px solid red",r.style.padding="1px",i--,await new Promise(e=>setTimeout(e,300))}}await new Promise(e=>setTimeout(e,500)),t.innerHTML=`<p>AIが生成: ${a.name} (${a.formula}) - ${a.point} ポイント</p>`,updatePoints(a,n),replaceUsedCards(a,aiHand,!0)}else{let o=decideElementsToExchange(aiHand);if(o){let c=document.querySelector(`#aiHand img[alt="Element ${o}"]`).parentNode;c.classList.add("selected"),c.style.border="5px solid red",c.style.padding="1px",await new Promise(e=>setTimeout(e,300));let m=aiHand.indexOf(o);m>-1&&(aiHand[m]=drawRandomElements(elements,1)[0],displayHand(aiHand,"aiHand"))}}disableButtons(!1),isPlayerTurn=!0,console.log("現在のプレイヤーの手札:",playerHand)}async function listCreatableMaterials(e){let n=[],t=getCombinations(e);for(let a of t){let l={};a.forEach(e=>l[e]=(l[e]||0)+1);let i=await findMaterials(l);n.push(...i)}return n}function getCombinations(e){let n=[],t=(e,a,l)=>{if(0===l){n.push(e);return}for(let i=0;i<a.length;i++)t(e.concat(a[i]),a.slice(i+1),l-1)};for(let a=1;a<=e.length;a++)t([],e,a);return n}function canGenerateCompound(e,n){let t={};for(let a in e.forEach(e=>t[e]=(t[e]||0)+1),n.components)if(!t[a]||t[a]<n.components[a])return!1;return!0}function decideCompound(e,n){let t=null,a=0;for(let l of n)canGenerateCompound(e,l)&&l.point>a&&(t=l,a=l.point);return t}function decideElementsToExchange(e){let n={};e.forEach(e=>n[e]=(n[e]||0)+1);let t=1/0,a=null;for(let l in n)n[l]<t&&(t=n[l],a=l);return a}function clearAISelection(){let e=document.querySelectorAll("#aiHand .selected");e.forEach(e=>{e.classList.remove("selected"),e.style.padding="5px",e.style.border="1px solid black"})}function checkWinCondition(){if(!(playerPoints>250)&&!(aiPoints>250))return}function initializeHands(){isPlayerTurn=!0,aiHand=drawRandomElements(elements,8),playerHand=drawRandomElements(elements,8),displayHand(aiHand,"aiHand"),displayHand(playerHand,"hand")}document.getElementById("exchangeButton").addEventListener("click",()=>{document.querySelectorAll("#hand .selected img").forEach(e=>{let n=e.alt.split(" ")[1],t=playerHand.indexOf(n);if(t>-1){let a=elements[Math.floor(Math.random()*elements.length)],l=elementToNumber[a];playerHand[t]=a,e.src=imageCache[l].src,e.alt=`Element ${a}`}e.parentNode.classList.remove("selected"),e.style.border="1px solid black",e.style.padding="5px"}),selectedElements={},displayHand(playerHand,"hand"),aiTurn()}),document.getElementById("searchButton").addEventListener("click",async()=>{let e=await findMaterials(selectedElements),n=document.getElementById("results"),t=document.getElementById("points");n.innerHTML="",e.length>0?(e.forEach(e=>{n.innerHTML+=`<p>${e.name} (${e.formula}) - ${e.point} ポイント</p>`,playerPoints+=e.point,replaceUsedCards(e,playerHand)}),t.textContent=`ポイント： ${playerPoints}`,checkWinCondition()):n.innerHTML="<p>該当する物質が見つかりませんでした。</p>",aiTurn()}),document.getElementById("startButton").addEventListener("click",()=>{initializeHands(),selectedElements={},displayHand(currentHand=drawRandomElements(elements,8),"hand"),displayHand(aiHand=drawRandomElements(elements,8),"aiHand"),document.getElementById("startButton").style.display="none",document.getElementById("exchangeButton").style.display="inline-block",document.getElementById("searchButton").style.display="inline-block"}),document.addEventListener("DOMContentLoaded",function(){preloadImages(),loadMaterials()});
